<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Mysql一主二从 （4）- MHA 安装 - Hexo</title><link rel="manifest" href="/blog/manifest.json"><meta name="theme-color" content="#f7f7f7"><meta name="application-name" content="Icaurs - Hexo Theme"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="msapplication-TileColor" content="#f7f7f7"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Icaurs - Hexo Theme"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="MHA 目前在 MYSQL 高可用方面是一个相对成熟的解决方案，是一套在 MYSQL 高可用性环境下进行故障切换和主从提升的优秀软件。在 MYSQL 故障切换的过程中，最大程度地保证数据的完整性和一致性，以达到真正意义上的高可用。接下来本文将描述如何使用 MHA 来搭建一个一主二从的 MYSQL 集群。"><meta property="og:type" content="blog"><meta property="og:title" content="Mysql一主二从 （4）- MHA 安装"><meta property="og:url" content="https://cocozwwang.github.io/blog/2024/03/07/Mysql/Mysql%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E%20%EF%BC%884%EF%BC%89-%20MHA%20%E5%AE%89%E8%A3%85/"><meta property="og:site_name" content="Hexo"><meta property="og:description" content="MHA 目前在 MYSQL 高可用方面是一个相对成熟的解决方案，是一套在 MYSQL 高可用性环境下进行故障切换和主从提升的优秀软件。在 MYSQL 故障切换的过程中，最大程度地保证数据的完整性和一致性，以达到真正意义上的高可用。接下来本文将描述如何使用 MHA 来搭建一个一主二从的 MYSQL 集群。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cocozwwang.github.io/blog/2024/03/07/Mysql/Mysql%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E%20%EF%BC%884%EF%BC%89-%20MHA%20%E5%AE%89%E8%A3%85/mha_arch.png"><meta property="og:image" content="https://cocozwwang.github.io/blog/2024/03/07/Mysql/Mysql%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E%20%EF%BC%884%EF%BC%89-%20MHA%20%E5%AE%89%E8%A3%85/mha_failover_2_1.png"><meta property="og:image" content="https://cocozwwang.github.io/blog/2024/03/07/Mysql/Mysql%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E%20%EF%BC%884%EF%BC%89-%20MHA%20%E5%AE%89%E8%A3%85/mha_failover_2_2.png"><meta property="article:published_time" content="2024-03-07T07:08:53.000Z"><meta property="article:modified_time" content="2024-03-08T15:27:31.339Z"><meta property="article:author" content="cocoZWWang"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://cocozwwang.github.io/blog/2024/03/07/Mysql/Mysql%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E%20%EF%BC%884%EF%BC%89-%20MHA%20%E5%AE%89%E8%A3%85/mha_arch.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://cocozwwang.github.io/blog/2024/03/07/Mysql/Mysql%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E%20%EF%BC%884%EF%BC%89-%20MHA%20%E5%AE%89%E8%A3%85/"},"headline":"Mysql一主二从 （4）- MHA 安装","image":["https://cocozwwang.github.io/blog/2024/03/07/Mysql/Mysql%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E%20%EF%BC%884%EF%BC%89-%20MHA%20%E5%AE%89%E8%A3%85/mha_arch.png","https://cocozwwang.github.io/blog/2024/03/07/Mysql/Mysql%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E%20%EF%BC%884%EF%BC%89-%20MHA%20%E5%AE%89%E8%A3%85/mha_failover_2_1.png","https://cocozwwang.github.io/blog/2024/03/07/Mysql/Mysql%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E%20%EF%BC%884%EF%BC%89-%20MHA%20%E5%AE%89%E8%A3%85/mha_failover_2_2.png"],"datePublished":"2024-03-07T07:08:53.000Z","dateModified":"2024-03-08T15:27:31.339Z","author":{"@type":"Person","name":"cocoZWWang"},"publisher":{"@type":"Organization","name":"Hexo","logo":{"@type":"ImageObject","url":"https://cocozwwang.github.io/img/logo.svg"}},"description":"MHA 目前在 MYSQL 高可用方面是一个相对成熟的解决方案，是一套在 MYSQL 高可用性环境下进行故障切换和主从提升的优秀软件。在 MYSQL 故障切换的过程中，最大程度地保证数据的完整性和一致性，以达到真正意义上的高可用。接下来本文将描述如何使用 MHA 来搭建一个一主二从的 MYSQL 集群。"}</script><link rel="canonical" href="https://cocozwwang.github.io/blog/2024/03/07/Mysql/Mysql%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E%20%EF%BC%884%EF%BC%89-%20MHA%20%E5%AE%89%E8%A3%85/"><link rel="icon" href="/blog/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/blog/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-72437521-5" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-72437521-5');</script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.1.1"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/blog/"><img src="/blog/img/logo.svg" alt="Hexo" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/blog/">Home</a><a class="navbar-item" href="/blog/archives">Archives</a><a class="navbar-item" href="/blog/categories">Categories</a><a class="navbar-item" href="/blog/tags">Tags</a><a class="navbar-item" href="/blog/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Discuss on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus/discussions"><i class="fas fa-comments"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-03-07T07:08:53.000Z" title="2024/3/7 15:08:53">2024-03-07</time>发表</span><span class="level-item"><a class="link-muted" href="/blog/categories/Mysql/">Mysql</a></span><span class="level-item">30 分钟读完 (大约4529个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">Mysql一主二从 （4）- MHA 安装</h1><div class="content"><p>MHA 目前在 MYSQL 高可用方面是一个相对成熟的解决方案，是一套在 MYSQL 高可用性环境下进行故障切换和主从提升的优秀软件。在 MYSQL 故障切换的过程中，最大程度地保证数据的完整性和一致性，以达到真正意义上的高可用。接下来本文将描述如何使用 MHA 来搭建一个一主二从的 MYSQL 集群。</p>
<span id="more"></span>

<h1 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h1><p><img src="/blog/2024/03/07/Mysql/Mysql%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E%20%EF%BC%884%EF%BC%89-%20MHA%20%E5%AE%89%E8%A3%85/mha_arch.png" alt="图 1"></p>
<h2 id="传统复制："><a href="#传统复制：" class="headerlink" title="传统复制："></a>传统复制：</h2><ol>
<li>从宕机崩溃的 Master 保存二进制日记事件（BINLOG event）。</li>
<li>识别含有最新更新的 slave。</li>
<li>应用差异的中继日志（Relay Log）到其他 Slave。</li>
<li>应用从 Master 保存的二进制日志事件。</li>
<li>提升一个 Slave 为新的 Master。</li>
<li>使其他 Slave 连接到新的 Master 进行复制。</li>
</ol>
<h2 id="GTID-复制模式："><a href="#GTID-复制模式：" class="headerlink" title="GTID 复制模式："></a>GTID 复制模式：</h2><ol>
<li>识别含有最新更新的 Slave。</li>
<li>复制差异的 BINLOG 数据到其他 Slave。</li>
<li>提升一个 Slave 为新的 Master。</li>
<li>使其他 Slave 连接到新的 Master 进行复制。</li>
</ol>
<h1 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h1><figure class="highlight plaintext"><figcaption><span>MHA Manager >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">masterha_check_ssh：MHA SSH 免密通信环境检测工具</span><br><span class="line">masterha_check_repl：Mysql 复制环境检测工具</span><br><span class="line">masterha_manager：MHA 服务主程序</span><br><span class="line">masterha_check_status：MHA 运行状态检测工具</span><br><span class="line">masterha_master_monitor：Mysql master 节点性能检测工具</span><br><span class="line">masterha_master_swich：master 节点切换工具</span><br><span class="line">masterha_conf_host：添加或者删除配置的节点</span><br><span class="line">masterha_stop：关闭 MHA 服务的工具</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><figcaption><span>MHA Node >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">save_binary_logs：保存和复制 master 的二进制日志</span><br><span class="line">apply_diff_replay_logs：识别差异的中继日志事件并应用到其他 slave 节点</span><br><span class="line">filter_mysqlbinlog：去除不必要的 Rollback 事件（MHA 已经不使用这个工具）</span><br><span class="line">purge_replay_logs：清楚中继日志（不会阻塞 sql 线程）</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><figcaption><span>自定义扩展 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">secondary_check_script：通过多条网络路由检测 master 的可用性。</span><br><span class="line">master_ip_failover_script：检测 application 使用的 masterip。</span><br><span class="line">shutdown_script：强制关闭 master 节点。</span><br><span class="line">init_conf_load_script：加载初始配置参数。</span><br><span class="line">master_ip_online_change_script：更新 master 节点 ip 地址。</span><br></pre></td></tr></table></figure>

<h2 id="使用要点"><a href="#使用要点" class="headerlink" title="使用要点"></a>使用要点</h2><ul>
<li>MHA Manager 可以单独部署在一台服务器，可以同时管理多个  MYSQL  集群。</li>
<li>MHA Manager 也可以部署在其中一台<strong>从节点</strong>上，但是不能在<strong>主节点</strong>上，否则一尸两命。</li>
<li>MHA Manager 在进行故障转移后，会停止自身进程，需要运维人员再次启动，如果 MHA Manager 节点被提升为主节点，需要在其他从节点启动 MHA Manager。</li>
</ul>
<h2 id="MHA-Manager-高可用"><a href="#MHA-Manager-高可用" class="headerlink" title="MHA Manager 高可用"></a>MHA Manager 高可用</h2><p>MHA 目前不支持多个 Manager 同时监控一个 MYSQL 主从集群，因此，如果 MHA Manager 宕机，就无法启动主节点的故障转移。但是，MHA Manager 本身不参与业务，因此其单点故障的潜在威胁比较低，唯一需要避免的就是主节点和 MHA Manager 同时宕机。</p>
<p>可以考虑下面两种方法来提高 MHA 的可用性：</p>
<ul>
<li><p>对 MHA Manager 进行监控，发生单点故障时能及时通知运维人员进行处理。</p>
</li>
<li><p>可以选择使用 Pacemaker 等常见的主&#x2F;备作为其高可用方案。</p>
</li>
</ul>
<h1 id="安装-MHA"><a href="#安装-MHA" class="headerlink" title="安装 MHA"></a>安装 MHA</h1><h2 id="安装-MHA-Node"><a href="#安装-MHA-Node" class="headerlink" title="安装 MHA Node"></a>安装 MHA Node</h2><blockquote>
<p>注意：每个节点都需要安装 MHA Node，包括 MHA Manager</p>
</blockquote>
<figure class="highlight shell"><figcaption><span>1. 安装 epel 源 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node4 ~]# yum install -y epel-release</span><br><span class="line">[root@node4 ~]# yum clean all</span><br><span class="line">[root@node4 ~]# yum makecache</span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><figcaption><span>2. 下载并安装 MHA Node >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost tmp]# wget -P /tmp https://github.com/yoshinorim/mha4mysql-node/releases/download/v0.58/mha4mysql-node-0.58-0.el7.centos.noarch.rpm</span><br><span class="line">[root@node4 ~]# yum install -y /tmp/mha4mysql-node-0.58-0.el7.centos.noarch.rpm</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><figcaption><span>3. 安装完成后会在 /usr/bin 目录生成如下脚本 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/save_binary_logs #保存和复制 master 的二进制日志</span><br><span class="line">/usr/bin/apply_diff_replay_logs #识别差异的中继日志事件并应用到其他 slave 节点</span><br><span class="line">/usr/bin/filter_mysqlbinlog #去除不必要的 Rollback 事件（MHA 已经不使用这个工具）</span><br><span class="line">/usr/bin/purge_replay_logs #清楚中继日志（不会阻塞 sql 线程）</span><br></pre></td></tr></table></figure>


<h2 id="安装-MHA-Manager"><a href="#安装-MHA-Manager" class="headerlink" title="安装 MHA Manager"></a>安装 MHA Manager</h2><h3 id="配置主库"><a href="#配置主库" class="headerlink" title="配置主库"></a>配置主库</h3><figure class="highlight sql"><figcaption><span>1. 在主节点（node1）上创建 mha 的监测账号 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># MHA 默认使用 mysql_native_password 认证方式</span><br><span class="line">root<span class="variable">@localhost</span> (<span class="keyword">none</span>) :<span class="number">37</span>: <span class="operator">&gt;</span><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;mhauser&#x27;</span>@<span class="string">&#x27;192.168.3.%&#x27;</span> identified <span class="keyword">with</span> mysql_native_password <span class="keyword">by</span> <span class="string">&#x27;mhapass&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.03</span> sec)</span><br><span class="line"></span><br><span class="line">root<span class="variable">@localhost</span> (<span class="keyword">none</span>) :<span class="number">40</span>: <span class="operator">&gt;</span>flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">root<span class="variable">@localhost</span> (<span class="keyword">none</span>) :<span class="number">40</span>: <span class="operator">&gt;</span><span class="keyword">grant</span> <span class="keyword">all</span> privileges <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;mhauser&#x27;</span>@<span class="string">&#x27;192.168.3.%&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>


<figure class="highlight sql"><figcaption><span>2. 检测账号是否同步完毕 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 由于前面配置了主从复制，因此我们不需要在从节点上重复创建，也一定不要创建（会冲突）</span><br><span class="line">[root<span class="variable">@localhost</span> tmp]# ssh node2</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;select user,host from mysql.user where user=&#x27;mhauser&#x27;;&quot;</span><br><span class="line">Enter password:</span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">user</span>    <span class="operator">|</span> host        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-------------+</span></span><br><span class="line"><span class="operator">|</span> mhauser <span class="operator">|</span> <span class="number">192.168</span><span class="number">.3</span>.<span class="operator">%</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-------------+</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@localhost</span> tmp]# ssh node3</span><br><span class="line">[root<span class="variable">@node3</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>e &quot;select user,host from mysql.user where user=&#x27;mhauser&#x27;;&quot;</span><br><span class="line">Enter password:</span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">user</span>    <span class="operator">|</span> host        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-------------+</span></span><br><span class="line"><span class="operator">|</span> mhauser <span class="operator">|</span> <span class="number">192.168</span><span class="number">.3</span>.<span class="operator">%</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+-------------+</span></span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><figcaption><span>3. 配置主节点的浮动 IP: 192.168.3.200/24 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost tmp]# ip addr add 192.168.3.200/24 dev ens33</span><br><span class="line">[root@localhost tmp]# ip addr list ens33</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:ca:2b:a0 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.3.131/24 brd 192.168.3.255 scope global noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    # 在网络接口 ens33 上新配置的 ip 地址</span><br><span class="line">    inet 192.168.3.200/24 scope global secondary ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::25c7:c0dc:4aeb:8e4/64 scope link noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   </span><br></pre></td></tr></table></figure>

<h3 id="配置-MHA-Manager-节点"><a href="#配置-MHA-Manager-节点" class="headerlink" title="配置 MHA Manager 节点"></a>配置 MHA Manager 节点</h3><blockquote>
<p>我们选择从节点 node3 部署 MHA Manager</p>
</blockquote>
<figure class="highlight shell"><figcaption><span>1. 下载 rpm 包并安装 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载 MHA Manager rpm 包</span></span><br><span class="line">[root@localhost tmp]# wget -P /tmp https://github.com/yoshinorim/mha4mysql-manager/releases/download/v0.58/mha4mysql-manager-0.58-0.el7.centos.noarch.rpm</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 MHA Manager</span></span><br><span class="line">yum install -y /tmp/mha4mysql-manager-0.58-0.el7.centos.noarch.rpm</span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><figcaption><span>1. 创建 MHA Manager 的配置文件夹 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 ~]# mkdir -pv /etc/masterha</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">app1 为 MYSQL 集群的名称（任意）</span></span><br><span class="line">[root@node3 ~]# mkdir -pv /data/masterha/app1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">由于 MHA Manager 也有可能在其他从节点运行，因此同样在其他节点也顺便创建配置文件夹</span></span><br><span class="line">[root@node3 ~]# ssh node1 &#x27;mkdir -pv /data/masterha/app1&#x27;</span><br><span class="line">[root@node3 ~]# ssh node2 &#x27;mkdir -pv /data/masterha/app1&#x27;</span><br></pre></td></tr></table></figure>


<figure class="highlight perl"><figcaption><span>3. 创建自动故障转移时的回调脚本`/usr/local/bin/master_ip_failover` >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env perl</span></span><br><span class="line"><span class="comment">#  Copyright (C) 2011 DeNA Co.,Ltd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is free software; you can redistribute it and/or modify</span></span><br><span class="line"><span class="comment">#  it under the terms of the GNU General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment">#  GNU General Public License for more details.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  You should have received a copy of the GNU General Public License</span></span><br><span class="line"><span class="comment">#   along with this program; if not, write to the Free Software</span></span><br><span class="line"><span class="comment">#  Foundation, Inc.,</span></span><br><span class="line"><span class="comment">#  51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Note: This is a sample script and is not complete. Modify the script based on your environment.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 脚本官方样例：https://github.com/yoshinorim/mha4mysql-manager/blob/master/samples/scripts/master_ip_failover，下面脚本是在官方脚本的基础上做的修改，修改的地方有中文注释说明</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> strict;</span><br><span class="line"><span class="keyword">use</span> warnings <span class="string">FATAL =&gt;</span> <span class="string">&#x27;all&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> Getopt::Long;</span><br><span class="line"><span class="keyword">use</span> MHA::DBHelper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> (</span><br><span class="line">  $command,        $ssh_user,         $orig_master_host,</span><br><span class="line">  $orig_master_ip, $orig_master_port, $new_master_host,</span><br><span class="line">  $new_master_ip,  $new_master_port,  $new_master_user,</span><br><span class="line">  $new_master_password</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">##### 浮动 ip 配置</span></span><br><span class="line"><span class="keyword">my</span> $vip = <span class="string">&#x27;192.168.3.200/24&#x27;</span>; <span class="comment"># 修改成你需要的 virtual ip </span></span><br><span class="line"><span class="keyword">my</span> $net_dev = <span class="string">&quot;ens33&quot;</span>; <span class="comment"># 修改成你的网络设备</span></span><br><span class="line"><span class="keyword">my</span> $ssh_start_vip = <span class="string">&quot;ip addr add $vip dev $net_dev&quot;</span>; </span><br><span class="line"><span class="keyword">my</span> $ssh_stop_vip = <span class="string">&quot;ip addr del $vip dev $net_dev&quot;</span>;</span><br><span class="line"></span><br><span class="line">GetOptions(</span><br><span class="line">  <span class="string">&#x27;command=s&#x27;</span>             =&gt; \$command,</span><br><span class="line">  <span class="string">&#x27;ssh_user=s&#x27;</span>            =&gt; \$ssh_user,</span><br><span class="line">  <span class="string">&#x27;orig_master_host=s&#x27;</span>    =&gt; \$orig_master_host,</span><br><span class="line">  <span class="string">&#x27;orig_master_ip=s&#x27;</span>      =&gt; \$orig_master_ip,</span><br><span class="line">  <span class="string">&#x27;orig_master_port=i&#x27;</span>    =&gt; \$orig_master_port,</span><br><span class="line">  <span class="string">&#x27;new_master_host=s&#x27;</span>     =&gt; \$new_master_host,</span><br><span class="line">  <span class="string">&#x27;new_master_ip=s&#x27;</span>       =&gt; \$new_master_ip,</span><br><span class="line">  <span class="string">&#x27;new_master_port=i&#x27;</span>     =&gt; \$new_master_port,</span><br><span class="line">  <span class="string">&#x27;new_master_user=s&#x27;</span>     =&gt; \$new_master_user,</span><br><span class="line">  <span class="string">&#x27;new_master_password=s&#x27;</span> =&gt; \$new_master_password,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span> &amp;main();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">main</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( $command eq <span class="string">&quot;stop&quot;</span> || $command eq <span class="string">&quot;stopssh&quot;</span> ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># $orig_master_host, $orig_master_ip, $orig_master_port are passed.</span></span><br><span class="line">    <span class="comment"># If you manage master ip address at global catalog database,</span></span><br><span class="line">    <span class="comment"># invalidate orig_master_ip here.</span></span><br><span class="line">    <span class="keyword">my</span> $exit_code = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">eval</span> &#123;</span><br><span class="line">      <span class="comment"># updating global catalog, etc</span></span><br><span class="line">      <span class="comment"># 故障转移时，旧 Master 节点的回调处理</span></span><br><span class="line">      <span class="keyword">print</span> <span class="string">&quot;disabling the vip on old master: $orig_master_host \n&quot;</span>;</span><br><span class="line">      &amp;stop_vip();</span><br><span class="line"></span><br><span class="line">      $exit_code = <span class="number">0</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> ($@) &#123;</span><br><span class="line">      <span class="keyword">warn</span> <span class="string">&quot;Got Error: $@\n&quot;</span>;</span><br><span class="line">      <span class="keyword">exit</span> $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span> $exit_code;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">elsif</span> ( $command eq <span class="string">&quot;start&quot;</span> ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># all arguments are passed.</span></span><br><span class="line">    <span class="comment"># If you manage master ip address at global catalog database,</span></span><br><span class="line">    <span class="comment"># activate new_master_ip here.</span></span><br><span class="line">    <span class="comment"># You can also grant write access (create user, set read_only=0, etc) here.</span></span><br><span class="line">    <span class="keyword">my</span> $exit_code = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">eval</span> &#123;</span><br><span class="line">      <span class="comment">## Update master ip on the catalog database, etc</span></span><br><span class="line">      <span class="comment">## 故障转移时，新 Master 节点的回调处理</span></span><br><span class="line">      <span class="keyword">print</span> <span class="string">&quot;Enabling the VIP - $vip on the new master - $new_master_host\n&quot;</span>;</span><br><span class="line">      &amp;start_vip();</span><br><span class="line"></span><br><span class="line">      $exit_code = <span class="number">0</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> ($@) &#123;</span><br><span class="line">      <span class="keyword">warn</span> $@;</span><br><span class="line"></span><br><span class="line">      <span class="comment"># If you want to continue failover, exit 10.</span></span><br><span class="line">      <span class="keyword">exit</span> $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span> $exit_code;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">elsif</span> ( $command eq <span class="string">&quot;status&quot;</span> ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># do nothing</span></span><br><span class="line">    <span class="keyword">exit</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    &amp;usage();</span><br><span class="line">    <span class="keyword">exit</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动浮动 IP</span></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">start_vip</span></span>()&#123;</span><br><span class="line">    <span class="string">`ssh $ssh_user\@$new_master_host \&quot; $ssh_start_vip \&quot;`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭浮动 IP</span></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">stop_vip</span></span>()&#123;</span><br><span class="line">    <span class="string">`ssh $ssh_user\@$orig_master_host \&quot; $ssh_stop_vip \&quot;`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">usage</span> </span>&#123;</span><br><span class="line">  <span class="keyword">print</span></span><br><span class="line"><span class="string">&quot;Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight ini"><figcaption><span>4. 创建 MYSQL 集群的配置文件：`/etc/masterha/app1.cnf` >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务默认配置</span></span><br><span class="line"><span class="section">[server default]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ssh</span></span><br><span class="line"><span class="attr">ssh_user</span>=root</span><br><span class="line"><span class="attr">ssh_port</span>=<span class="number">22</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mha 工作目录</span></span><br><span class="line"><span class="attr">manager_workdir</span>=/data/masterha/app1</span><br><span class="line"><span class="attr">manager_log</span>=/data/masterha/app1/manager.log</span><br><span class="line"><span class="attr">remote_workdir</span>=/data/masterha/app1</span><br><span class="line"></span><br><span class="line"><span class="comment">## Mysql</span></span><br><span class="line"><span class="comment"># mha manager 用例管理其他 mysql 服务的超级权限账号</span></span><br><span class="line"><span class="attr">user</span>=mhauser</span><br><span class="line"><span class="attr">password</span>=mhapass</span><br><span class="line"><span class="comment"># 复制账号</span></span><br><span class="line"><span class="attr">repl_user</span>=repluser</span><br><span class="line"><span class="attr">repl_password</span>=replpass</span><br><span class="line"><span class="comment"># mha 监控心跳周期</span></span><br><span class="line"><span class="attr">ping_interval</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">ping_type</span>=connect</span><br><span class="line"><span class="comment"># 自动 failover 时候的切换脚本</span></span><br><span class="line"><span class="attr">master_ip_failover_script</span>=/usr/local/bin/master_ip_failover</span><br><span class="line"><span class="comment"># 手动切换时候的切换脚本</span></span><br><span class="line"><span class="attr">master_ip_online_change_script</span>=/usr/local/bin/master_ip_online_change</span><br><span class="line"><span class="comment"># 故障转移后发送告警通知脚本</span></span><br><span class="line"><span class="attr">report_script</span>=/usr/local/bin/send_report</span><br><span class="line"><span class="comment"># 一旦 mha 到 node1 的监控之间网络出现了问题，mha manager 将会尝试从 node2 登录到 node1</span></span><br><span class="line"><span class="attr">secondary_check_script</span>=/usr/bin/masterha_secondary_check -s node2 --user=root --master_host=node1 --master_ip=<span class="number">192.168</span>.<span class="number">3.131</span> --master_port=<span class="number">3306</span></span><br><span class="line"><span class="comment"># 故障发送后关闭故障主机脚本，防止发生脑裂</span></span><br><span class="line"><span class="attr">shutdown_script</span>=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[server1]</span></span><br><span class="line"><span class="attr">hostname</span>=node1</span><br><span class="line"><span class="attr">candidate_master</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="section">[server2]</span></span><br><span class="line"><span class="attr">hostname</span>=node2</span><br><span class="line"><span class="attr">candidate_master</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="section">[server3]</span></span><br><span class="line"><span class="attr">hostname</span>=node3</span><br><span class="line"><span class="attr">candidate_master</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="启动-MHA-Manager"><a href="#启动-MHA-Manager" class="headerlink" title="启动 MHA Manager"></a>启动 MHA Manager</h3><figure class="highlight shell"><figcaption><span>1. 检测集群 SSH 互通状态 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 ~]# masterha_check_ssh --conf=/etc/masterha/app1.cnf</span><br><span class="line">Thu Feb 29 18:33:15 2024 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Thu Feb 29 18:33:15 2024 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Thu Feb 29 18:33:15 2024 - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Thu Feb 29 18:33:15 2024 - [info] Starting SSH connection tests..</span><br><span class="line">Thu Feb 29 18:33:16 2024 - [debug]</span><br><span class="line">Thu Feb 29 18:33:15 2024 - [debug]  Connecting via SSH from root@node1(192.168.3.131:22) to root@node2(192.168.3.132:22)..</span><br><span class="line">Thu Feb 29 18:33:16 2024 - [debug]   ok.</span><br><span class="line">Thu Feb 29 18:33:16 2024 - [debug]  Connecting via SSH from root@node1(192.168.3.131:22) to root@node3(192.168.3.133:22)..</span><br><span class="line">Thu Feb 29 18:33:16 2024 - [debug]   ok.</span><br><span class="line">Thu Feb 29 18:33:17 2024 - [debug]</span><br><span class="line">Thu Feb 29 18:33:15 2024 - [debug]  Connecting via SSH from root@node2(192.168.3.132:22) to root@node1(192.168.3.131:22)..</span><br><span class="line">Thu Feb 29 18:33:16 2024 - [debug]   ok.</span><br><span class="line">Thu Feb 29 18:33:16 2024 - [debug]  Connecting via SSH from root@node2(192.168.3.132:22) to root@node3(192.168.3.133:22)..</span><br><span class="line">Thu Feb 29 18:33:17 2024 - [debug]   ok.</span><br><span class="line">Thu Feb 29 18:33:17 2024 - [debug]</span><br><span class="line">Thu Feb 29 18:33:16 2024 - [debug]  Connecting via SSH from root@node3(192.168.3.133:22) to root@node1(192.168.3.131:22)..</span><br><span class="line">Thu Feb 29 18:33:17 2024 - [debug]   ok.</span><br><span class="line">Thu Feb 29 18:33:17 2024 - [debug]  Connecting via SSH from root@node3(192.168.3.133:22) to root@node2(192.168.3.132:22)..</span><br><span class="line">Thu Feb 29 18:33:17 2024 - [debug]   ok.</span><br><span class="line">Thu Feb 29 18:33:17 2024 - [info] All SSH connection tests passed successfully.</span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><figcaption><span>2. 检测集群同步状态 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 ~]# masterha_check_repl --conf=/etc/masterha/app1.cnf</span><br><span class="line">Thu Feb 29 19:39:17 2024 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Thu Feb 29 19:39:17 2024 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Thu Feb 29 19:39:17 2024 - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Thu Feb 29 19:39:17 2024 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info] GTID failover mode = 1</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info] Dead Servers:</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info] Alive Servers:</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info]   node1(192.168.3.131:3306)</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info]   node2(192.168.3.132:3306)</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info]   node3(192.168.3.133:3306)</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info] Alive Slaves:</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info]   node2(192.168.3.132:3306)  Version=8.0.27 (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info]     GTID ON</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info]     Replicating from 192.168.3.131(192.168.3.131:3306)</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info]   node3(192.168.3.133:3306)  Version=8.0.27 (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info]     GTID ON</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info]     Replicating from 192.168.3.131(192.168.3.131:3306)</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info] Current Alive Master: node1(192.168.3.131:3306)</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info] Checking slave configurations..</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info] Checking replication filtering settings..</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info]  binlog_do_db= , binlog_ignore_db=</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info]  Replication filtering check ok.</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info] HealthCheck: SSH to node1 is reachable.</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info]</span><br><span class="line">node1(192.168.3.131:3306) (current master)</span><br><span class="line"> +--node2(192.168.3.132:3306)</span><br><span class="line"> +--node3(192.168.3.133:3306)</span><br><span class="line"></span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info] Checking replication health on node2..</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info]  ok.</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info] Checking replication health on node3..</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info]  ok.</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Thu Feb 29 19:39:18 2024 - [info]   /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=node1 --orig_master_ip=192.168.3.131 --orig_master_port=3306</span><br><span class="line">Thu Feb 29 19:39:19 2024 - [info]  OK.</span><br><span class="line">Thu Feb 29 19:39:19 2024 - [warning] shutdown_script is not defined.</span><br><span class="line">Thu Feb 29 19:39:19 2024 - [info] Got exit code 0 (Not master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication Health is OK.</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><figcaption><span>3. 启动 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 ~]# nohup masterha_manager --conf=/etc/masterha/app1.cnf --ignore_last_failove &lt; /dev/null &gt;/data/masterha/app1/manager.log 2&gt;&amp;1 &amp;</span><br><span class="line">[1] 15176</span><br><span class="line">[root@node3 ~]#</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><figcaption><span>4. 查看启动状态 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 ~]# tail -f /data/masterha/app1/manager.log</span><br><span class="line">Fri Mar  1 01:42:36 2024 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Fri Mar  1 01:42:36 2024 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Fri Mar  1 01:42:36 2024 - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Fri Mar  1 01:42:36 2024 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info] GTID failover mode = 1</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info] Dead Servers:</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info] Alive Servers:</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info]   node1(192.168.3.131:3306)</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info]   node2(192.168.3.132:3306)</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info]   node3(192.168.3.133:3306)</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info] Alive Slaves:</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info]   node2(192.168.3.132:3306)  Version=8.0.27 (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info]     GTID ON</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info]     Replicating from 192.168.3.131(192.168.3.131:3306)</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info]   node3(192.168.3.133:3306)  Version=8.0.27 (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info]     GTID ON</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info]     Replicating from 192.168.3.131(192.168.3.131:3306)</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info] Current Alive Master: node1(192.168.3.131:3306)</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info] Checking slave configurations..</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info] Checking replication filtering settings..</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info]  binlog_do_db= , binlog_ignore_db=</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info]  Replication filtering check ok.</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info] HealthCheck: SSH to node1 is reachable.</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info]</span><br><span class="line">node1(192.168.3.131:3306) (current master)</span><br><span class="line"> +--node2(192.168.3.132:3306)</span><br><span class="line"> +--node3(192.168.3.133:3306)</span><br><span class="line"></span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info]   /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=node1 --orig_master_ip=192.168.3.131 --orig_master_port=3306</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info]  OK.</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [warning] shutdown_script is not defined.</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info] Set master ping interval 1 seconds.</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info] Set secondary check script: /usr/bin/masterha_secondary_check -s node2 --user=root --master_host=node1 --master_ip=192.168.3.131 --master_port=3306</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info] Starting ping health check on node1(192.168.3.131:3306)..</span><br><span class="line">Fri Mar  1 01:42:37 2024 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond..</span><br></pre></td></tr></table></figure>

<h1 id="模拟故障转移"><a href="#模拟故障转移" class="headerlink" title="模拟故障转移"></a>模拟故障转移</h1><figure class="highlight cmd"><figcaption><span>1. 在 windows 主机通过浮动 IP 登录并查看 server_id >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">D:\<span class="title">Works</span>\<span class="title">mysql</span>-8.0.15-<span class="title">winx64</span>\<span class="title">bin</span>&gt;<span class="title">mysql</span> -<span class="title">umhauser</span> -<span class="title">p</span> -<span class="title">h</span> 192.168.3.200 -<span class="title">e</span> &quot;<span class="title">select</span> @@<span class="title">server_id</span>;&quot;</span></span><br><span class="line"><span class="function"><span class="title">Enter</span> <span class="title">password</span>: *******</span></span><br><span class="line"><span class="function">+-------------+</span></span><br><span class="line"><span class="function">| @@<span class="title">server_id</span> |</span></span><br><span class="line"><span class="function">+-------------+</span></span><br><span class="line"><span class="function">|           1 |</span></span><br><span class="line"><span class="function">+-------------+</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><figcaption><span>2. 停掉当前主节点（node1）上的 MYSQL 实例 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 停止 mysql 实例</span><br><span class="line">[root@localhost tmp]# systemctl stop mysqld</span><br><span class="line">[root@localhost tmp]# systemctl status mysqld</span><br><span class="line">● mysqld.service - LSB: start and stop MySQL</span><br><span class="line">   Loaded: loaded (/etc/rc.d/init.d/mysqld; bad; vendor preset: disabled)</span><br><span class="line">   Active: inactive (dead) since 五 2024-03-01 01:44:15 CST; 5s ago</span><br><span class="line">     Docs: man:systemd-sysv-generator(8)</span><br><span class="line">  Process: 47061 ExecStop=/etc/rc.d/init.d/mysqld stop (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 45134 ExecStart=/etc/rc.d/init.d/mysqld start (code=exited, status=0/SUCCESS)</span><br><span class="line"></span><br><span class="line"># 查看 ip 地址状态</span><br><span class="line">[root@localhost tmp]# ip addr list ens33</span><br><span class="line"># 浮动 ip &quot;192.168.3.200/24&quot; 已经被转移</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:ca:2b:a0 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.3.131/24 brd 192.168.3.255 scope global noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::25c7:c0dc:4aeb:8e4/64 scope link noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@localhost tmp]#</span><br></pre></td></tr></table></figure>


<figure class="highlight cmd"><figcaption><span>3. 再次在 windows 主机通过浮动 IP 登录并查看 server_id >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">D:\<span class="title">Works</span>\<span class="title">mysql</span>-8.0.15-<span class="title">winx64</span>\<span class="title">bin</span>&gt;<span class="title">mysql</span> -<span class="title">umhauser</span> -<span class="title">p</span> -<span class="title">h</span> 192.168.3.200 -<span class="title">e</span> &quot;<span class="title">select</span> @@<span class="title">server_id</span>;&quot;</span></span><br><span class="line"><span class="function"><span class="title">Enter</span> <span class="title">password</span>: *******</span></span><br><span class="line"><span class="function"># <span class="title">server_id</span> 已经由 1 变成了 2，也就说明了 <span class="title">node2</span> 成为了新的主节点，并且浮动 <span class="title">IP</span> 也已经转移到 <span class="title">node2</span>。</span></span><br><span class="line"><span class="function">+-------------+</span></span><br><span class="line"><span class="function">| @@<span class="title">server_id</span> |</span></span><br><span class="line"><span class="function">+-------------+</span></span><br><span class="line"><span class="function">|           2 |</span></span><br><span class="line"><span class="function">+-------------+</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><figcaption><span>4. 查看 node3 的主从状态 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@localhost (none) :58: &gt;show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for source to send event</span><br><span class="line">                  Master_Host: 192.168.3.132 # 主节点也已经切换到 node2</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000003</span><br><span class="line">          Read_Master_Log_Pos: 2264</span><br><span class="line">               Relay_Log_File: node3-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 418</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000003</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>

<p>MHA Manager 故障转移成功，并且整个过程对于 Client 端都是透明的。</p>
<h1 id="模拟故障恢复"><a href="#模拟故障恢复" class="headerlink" title="模拟故障恢复"></a>模拟故障恢复</h1><p>下面再用一个简单的情景模拟一下 MHA 故障转移和故障恢复，已经其是否能保障数据的完整性。</p>
<h2 id="故障转移："><a href="#故障转移：" class="headerlink" title="故障转移："></a>故障转移：</h2><figure class="highlight shell"><figcaption><span>1. 在主节点创建一张 student 表 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@localhost (none) :52: &gt;create database test;</span><br><span class="line">Query OK, 1 row affected (0.04 sec)</span><br><span class="line">root@localhost (none) :52: &gt;create table test.student( studentId int primary key, name varchar(50), age int);</span><br><span class="line">Query OK, 0 rows affected (0.07 sec)</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><figcaption><span>2. Client 端使用 10 条线程插入 10w 条数据 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 插入采用重试策略，插入返回失败会继续重试到成功为止</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MHADemo</span> <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;ApplicationReadyEvent&gt; &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(MHADemo.class,args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ApplicationReadyEvent applicationReadyEvent)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">10</span>;i++)&#123;</span><br><span class="line">            <span class="comment">// 每条线程插入 1w 条数据</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(task(i),<span class="string">&quot;Thread-&quot;</span>+i).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Runnable <span class="title function_">task</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> threadId)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ()-&gt;&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">studentId</span> <span class="operator">=</span> threadId;studentId &lt;=<span class="number">100_000</span>;studentId+=<span class="number">10</span>)&#123;</span><br><span class="line">                Map&lt;String,String&gt; student = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                student.put(<span class="string">&quot;studentId&quot;</span>,studentId + <span class="string">&quot;&quot;</span>);</span><br><span class="line">                student.put(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;name-&quot;</span>+studentId);</span><br><span class="line">                student.put(<span class="string">&quot;age&quot;</span>,(studentId % <span class="number">100</span>)+<span class="string">&quot;&quot;</span>);</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        jdbcTemplate.update(<span class="string">&quot;insert into test.student (studentId,name,age) values(?,?,?)&quot;</span>,</span><br><span class="line">                                student.get(<span class="string">&quot;studentId&quot;</span>), student.get(<span class="string">&quot;name&quot;</span>), student.get(<span class="string">&quot;age&quot;</span>));</span><br><span class="line">                        System.out.printf(<span class="string">&quot;[Thread-%s]: insert studentId: %s\n&quot;</span>,threadId,studentId);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        System.err.printf(<span class="string">&quot;[Thread-%s]: insert failed, studentId: %s\n&quot;</span>,threadId,studentId);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.printf(<span class="string">&quot;[Thread-%s]: insert completed\n&quot;</span>,threadId);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><figcaption><span>3. 在插入的过程中关闭主节点的 MYSQL 实例，此时 Client 端会插入失败，并且不断重试。 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/blog/2024/03/07/Mysql/Mysql%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E%20%EF%BC%884%EF%BC%89-%20MHA%20%E5%AE%89%E8%A3%85/mha_failover_2_1.png" alt="图 2"></p>
<figure class="highlight shell"><figcaption><span>4. MHA 故障转移成功，Client 重试成功，继续完成后面的数据插入。 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/blog/2024/03/07/Mysql/Mysql%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E%20%EF%BC%884%EF%BC%89-%20MHA%20%E5%AE%89%E8%A3%85/mha_failover_2_2.png" alt="图 3"></p>
<figure class="highlight shell"><figcaption><span>5. 查询 node2 和 node3 的数据完整性 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">都有全部 10w 条数据</span></span><br><span class="line">[root@node1 ~]# ssh node2</span><br><span class="line">Last login: Thu Feb 29 18:50:37 2024 from node1</span><br><span class="line">[root@node2 ~]# mysql -uroot -p -e &#x27;select count(*) from test.student;&#x27;</span><br><span class="line">Enter password:</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|   100000 |</span><br><span class="line">+----------+</span><br><span class="line">[root@node2 ~]# exit;</span><br><span class="line">登出</span><br><span class="line">Connection to node2 closed.</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# ssh node3</span><br><span class="line">Last login: Thu Feb 29 18:52:20 2024 from node1</span><br><span class="line">[root@node3 ~]# mysql -uroot -p -e &#x27;select count(*) from test.student;&#x27;</span><br><span class="line">Enter password:</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|   100000 |</span><br><span class="line">+----------+</span><br></pre></td></tr></table></figure>



<figure class="highlight cmd"><figcaption><span>5. 查询 node1 的数据 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># node1 只有故障前的部分数据</span><br><span class="line">[root@node1 ~]# systemctl <span class="built_in">start</span> mysqld</span><br><span class="line">[root@node1 ~]# mysql -uroot -p -e &#x27;select count(*) from test.student;&#x27;;</span><br><span class="line">Enter password:</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|    <span class="number">31189</span> |</span><br><span class="line">+----------+</span><br></pre></td></tr></table></figure>

<h2 id="故障回复："><a href="#故障回复：" class="headerlink" title="故障回复："></a>故障回复：</h2><figure class="highlight sql"><figcaption><span>1. 重新启动 node1 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&lt;</span><span class="operator">!</span><span class="comment">--code￼0--&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><figcaption><span>2. 把 node1 设置为 node2 的从节点加入集群 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">@localhost</span> (<span class="keyword">none</span>) :<span class="number">17</span>: <span class="operator">&gt;</span>stop slave;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">2</span> warnings (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root<span class="variable">@localhost</span> (<span class="keyword">none</span>) :<span class="number">17</span>: <span class="operator">&gt;</span>reset slave;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root<span class="variable">@localhost</span> (<span class="keyword">none</span>) :<span class="number">17</span>: <span class="operator">&gt;</span>change master <span class="keyword">to</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> master_host<span class="operator">=</span><span class="string">&#x27;192.168.3.132&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_user<span class="operator">=</span><span class="string">&#x27;repluser&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_password<span class="operator">=</span><span class="string">&#x27;replpass&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_auto_position<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">7</span> warnings (<span class="number">0.06</span> sec)</span><br><span class="line"></span><br><span class="line">root<span class="variable">@localhost</span> (<span class="keyword">none</span>) :<span class="number">18</span>: <span class="operator">&gt;</span><span class="keyword">start</span> slave;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">1</span> warning (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">root<span class="variable">@localhost</span> (<span class="keyword">none</span>) :<span class="number">18</span>: <span class="operator">&gt;</span><span class="keyword">show</span> slave status\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> source <span class="keyword">to</span> send event</span><br><span class="line">                  Master_Host: <span class="number">192.168</span><span class="number">.3</span><span class="number">.132</span></span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: <span class="number">3306</span></span><br><span class="line">                Connect_Retry: <span class="number">60</span></span><br><span class="line">              Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000009</span></span><br><span class="line">          Read_Master_Log_Pos: <span class="number">40520183</span></span><br><span class="line">               Relay_Log_File: node1<span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000002</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">2527803</span></span><br><span class="line">        Relay_Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000009</span></span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><figcaption><span>3. node1 成功从新的主节点上复制剩余的数据： >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">root@localhost (none) :18: &gt;select count(*) from test.student;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|    53421 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@localhost (none) :18: &gt;select count(*) from test.student;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|    66588 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost (none) :19: &gt;select count(*) from test.student;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|   100000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><figcaption><span>4. 修改 `/etc/masterha/app1.cnf` 的 `secondary_check_script` 参数 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改为 master_host=node2， master_ip=192.168.3.132， -s node1</span></span><br><span class="line">secondary_check_script=/usr/bin/masterha_secondary_check -s node1 --user=root --master_host=node2 --master_ip=192.168.3.132 --master_port=3306</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><figcaption><span>5. 重新启动 MHA Manager >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动前先检测集群的复制状态</span></span><br><span class="line">[root@node3 ~]# masterha_check_repl --conf=/etc/masterha/app1.cnf</span><br><span class="line">...</span><br><span class="line">MySQL Replication Health is OK.</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动</span></span><br><span class="line">[root@node3 ~]# nohup masterha_manager --conf=/etc/masterha/app1.cnf --ignore_last_failove &lt; /dev/null &gt;/data/masterha/app1/manager.log 2&gt;&amp;1 &amp;</span><br><span class="line">[1] 19535</span><br><span class="line">[root@node3 ~]#</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>《深入浅出 MYSQL》</p>
<p><a target="_blank" rel="noopener" href="https://github.com/yoshinorim/mha4mysql-manager">《MHA Manager Github》</a></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Mysql一主二从 （4）- MHA 安装</p><p><a href="https://cocozwwang.github.io/blog/2024/03/07/Mysql/Mysql一主二从 （4）- MHA 安装/">https://cocozwwang.github.io/blog/2024/03/07/Mysql/Mysql一主二从 （4）- MHA 安装/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>cocoZWWang</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2024-03-07</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2024-03-08</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="" rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></p></div></div></div></div></div><div class="sharethis-inline-share-buttons"></div><script src="//platform-api.sharethis.com/js/sharethis.js#property=5ab6f60ace89f00013641890&amp;product=inline-share-buttons" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/blog/2024/03/07/Mysql/Mysql%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E%20%EF%BC%885%EF%BC%89-%20%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Mysql一主二从 （5）- 负载均衡</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/blog/2024/03/07/Mysql/Mysql%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E%20%EF%BC%883%EF%BC%89-%20MYSQL%20%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"><span class="level-item">Mysql一主二从 （3）- MYSQL 集群搭建</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/blog/img/avatar.png" alt="cocoadel"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">cocoadel</p><p class="is-size-6 is-block">Web Developer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Earth, Solar System</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/blog/archives"><p class="title">17</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/blog/categories"><p class="title">3</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/blog/tags"><p class="title">6</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/cocoZwwang" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/cocoZwwang"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/blog/"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#工作原理"><span class="level-left"><span class="level-item">1</span><span class="level-item">工作原理</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#传统复制："><span class="level-left"><span class="level-item">1.1</span><span class="level-item">传统复制：</span></span></a></li><li><a class="level is-mobile" href="#GTID-复制模式："><span class="level-left"><span class="level-item">1.2</span><span class="level-item">GTID 复制模式：</span></span></a></li></ul></li><li><a class="level is-mobile" href="#组件"><span class="level-left"><span class="level-item">2</span><span class="level-item">组件</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#使用要点"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">使用要点</span></span></a></li><li><a class="level is-mobile" href="#MHA-Manager-高可用"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">MHA Manager 高可用</span></span></a></li></ul></li><li><a class="level is-mobile" href="#安装-MHA"><span class="level-left"><span class="level-item">3</span><span class="level-item">安装 MHA</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#安装-MHA-Node"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">安装 MHA Node</span></span></a></li><li><a class="level is-mobile" href="#安装-MHA-Manager"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">安装 MHA Manager</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#配置主库"><span class="level-left"><span class="level-item">3.2.1</span><span class="level-item">配置主库</span></span></a></li><li><a class="level is-mobile" href="#配置-MHA-Manager-节点"><span class="level-left"><span class="level-item">3.2.2</span><span class="level-item">配置 MHA Manager 节点</span></span></a></li><li><a class="level is-mobile" href="#启动-MHA-Manager"><span class="level-left"><span class="level-item">3.2.3</span><span class="level-item">启动 MHA Manager</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#模拟故障转移"><span class="level-left"><span class="level-item">4</span><span class="level-item">模拟故障转移</span></span></a></li><li><a class="level is-mobile" href="#模拟故障恢复"><span class="level-left"><span class="level-item">5</span><span class="level-item">模拟故障恢复</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#故障转移："><span class="level-left"><span class="level-item">5.1</span><span class="level-item">故障转移：</span></span></a></li><li><a class="level is-mobile" href="#故障回复："><span class="level-left"><span class="level-item">5.2</span><span class="level-item">故障回复：</span></span></a></li></ul></li><li><a class="level is-mobile" href="#参考资料"><span class="level-left"><span class="level-item">6</span><span class="level-item">参考资料</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/blog/js/toc.js" defer></script></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/blog/categories/Linux/"><span class="level-start"><span class="level-item">Linux</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/Mysql/"><span class="level-start"><span class="level-item">Mysql</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/%E7%AE%97%E6%B3%95/"><span class="level-start"><span class="level-item">算法</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-03-07T07:09:04.000Z">2024-03-07</time></p><p class="title"><a href="/blog/2024/03/07/Mysql/Mysql%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E%20%EF%BC%886%EF%BC%89-%20%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/">Mysql一主二从 （6）- 读写分离</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-03-07T07:08:59.000Z">2024-03-07</time></p><p class="title"><a href="/blog/2024/03/07/Mysql/Mysql%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E%20%EF%BC%885%EF%BC%89-%20%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">Mysql一主二从 （5）- 负载均衡</a></p><p class="categories"><a href="/blog/categories/Mysql/">Mysql</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-03-07T07:08:53.000Z">2024-03-07</time></p><p class="title"><a href="/blog/2024/03/07/Mysql/Mysql%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E%20%EF%BC%884%EF%BC%89-%20MHA%20%E5%AE%89%E8%A3%85/">Mysql一主二从 （4）- MHA 安装</a></p><p class="categories"><a href="/blog/categories/Mysql/">Mysql</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-03-07T07:08:44.000Z">2024-03-07</time></p><p class="title"><a href="/blog/2024/03/07/Mysql/Mysql%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E%20%EF%BC%883%EF%BC%89-%20MYSQL%20%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/">Mysql一主二从 （3）- MYSQL 集群搭建</a></p><p class="categories"><a href="/blog/categories/Mysql/">Mysql</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-03-07T07:01:06.000Z">2024-03-07</time></p><p class="title"><a href="/blog/2024/03/07/Mysql/Mysql%20%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E%EF%BC%882%EF%BC%89-%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">Mysql 一主二从（2）- 环境搭建</a></p><p class="categories"><a href="/blog/categories/Mysql/">Mysql</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/blog/archives/2024/03/"><span class="level-start"><span class="level-item">三月 2024</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/blog/archives/2024/02/"><span class="level-start"><span class="level-item">二月 2024</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/blog/tags/CentOS/"><span class="tag">CentOS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/LVS/"><span class="tag">LVS</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Linux/"><span class="tag">Linux</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Load-Balancer/"><span class="tag">Load Balancer</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Mysql/"><span class="tag">Mysql</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/VMware/"><span class="tag">VMware</span><span class="tag">1</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/blog/"><img src="/blog/img/logo.svg" alt="Hexo" height="28"></a><p class="is-size-7"><span>&copy; 2024 cocoZWWang</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Discuss on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus/discussions"><i class="fas fa-comments"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/blog/js/column.js"></script><script src="/blog/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/blog/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><!--!--><!--!--><script src="/blog/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/blog/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/blog/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>